<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>First Chapter | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-advanced-emoji/emoji-website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-disqus/plugin.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    
    <link rel="prev" href="./index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="1"
        data-chapter-title="First Chapter"
        data-filepath="chapter1.md"
        data-basepath="."
        data-revision="Wed Apr 20 2016 16:53:35 GMT+0800 (CST)"
        data-innerlanguage="en">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="1" data-path="chapter1.html">
            
                
                    <a href="./chapter1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        First Chapter
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h2 id="develop-enviroment-setup">Develop Enviroment Setup</h2>
<p><a href="https://github.com/google/protobuf/releases/tag/v3.0.0-beta-2" target="_blank">Protocol Buffers v3.0.0-beta-2</a></p>
<p>Released on Dec 31, 2015</p>
<pre><code class="lang-shell">libprotobuf.a, building for OSX, but linking in object file built for iOS, for architecture x86_64
</code></pre>
<p><a href="https://github.com/google/protobuf/releases/tag/v2.5.0" target="_blank">Protocol Buffers v2.5.0</a></p>
<p>Released on Feb 28, 2013</p>
<p> <br></p>
<h3 id="complie-libprotobufa">Complie <code>libprotobuf.a</code></h3>
<p><a href="https://github.com/sinofool/build-protobuf-ios" target="_blank">build-protobuf-ios</a></p>
<pre><code class="lang-shell">roor$ cd /usr/local/lib
roor$ ls -al
libprotobuf.a

root$ protoc --version
libprotoc 2.5.0
</code></pre>
<h4 id="arm-architecture">ARM architecture</h4>
<ul>
<li><p>x86_64</p>
<p>&#x200B;Mac OS X</p>
</li>
<li><p>i386
  iPhone Simulator</p>
</li>
<li><p>armv6</p>
<p>iPhone</p>
<p>iPhone2</p>
<p>iPhone3G</p>
<p>iPod Touch</p>
</li>
<li><p>armv7</p>
<p>iPhone3GS</p>
<p>iPhone4</p>
<p>iPhone4S</p>
<p>iPad</p>
<p>iPad2</p>
<p>iPad3</p>
<p>iPad mini</p>
<p>iPod Touch 3G</p>
<p>iPod Touch4</p>
</li>
<li><p>armv7s</p>
<p>iPhone5</p>
<p>iPhone5C</p>
<p>iPad4</p>
</li>
<li><p>arm64</p>
<p>iPhone5S</p>
<p>iPhone6</p>
<p>iPhone6 Plus</p>
<p>iPhone6S</p>
<p>iPad Air</p>
<p>iPad mini2</p>
</li>
</ul>
<p><code>lipo thin</code></p>
<pre><code class="lang-shell">lipo xxx.a -thin [armv7|armv7s|arm64|i386|x86_64] -output xxx_thin.a
</code></pre>
<p><br></p>
<h3 id="xcode-setup">Xcode Setup</h3>
<h4 id="add-source">Add Source</h4>
<ul>
<li><p>Add folder <code>protobuf-2.5.0/src/google</code> to <code>Xcode</code></p>
<pre><code class="lang-C++">      - Classes
        - protobuf
            - google
                - srouce code
            - lib
                - libprotobuf.a
</code></pre>
</li>
<li><p>Remove files</p>
<ul>
<li>All <code>.proto</code></li>
<li>All <code>.cc</code></li>
</ul>
</li>
<li><p>Remove folder</p>
<ul>
<li><code>testing</code> </li>
<li><code>testdata</code> </li>
</ul>
</li>
<li><p>Modify file <code>stubs/platform_macros.h</code></p>
<pre><code class="lang-C++"><span class="hljs-comment">// ...</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">elif</span> defined(__ppc__)</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> GOOGLE_PROTOBUF_ARCH_PPC <span class="hljs-number">1</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> GOOGLE_PROTOBUF_ARCH_32_BIT <span class="hljs-number">1</span></span>
<span class="hljs-comment">// add start</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">elif</span> defined(__aarch64__)</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> GOOGLE_PROTOBUF_ARCH_ARM <span class="hljs-number">1</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> GOOGLE_PROTOBUF_ARCH_64_BIT <span class="hljs-number">1</span></span>
<span class="hljs-comment">// add end</span>
<span class="hljs-comment">// ...</span>
</code></pre>
</li>
</ul>
<p><br></p>
<h4 id="add-libprotobufa">Add <code>libprotobuf.a</code></h4>
<p>Add the <code>libprotobuf.a</code> to <code>Build Parses ==&gt; Link Binary With Libraries</code></p>
<p><br></p>
<h4 id="modify-search-path">Modify Search Path</h4>
<ul>
<li><p><code>Build Settings == &gt; Search Paths ==&gt; User Header Search Paths</code></p>
<pre><code>        eg : `$(SRCROOT)/../Classes/protobuf`
</code></pre></li>
<li><p><code>Build Settings == &gt; Search Paths ==&gt; Library Search Paths</code></p>
<p>eg : <code>$(SRCROOT)/../Classes/protobuf/lib</code></p>
</li>
</ul>
<p><br></p>
<h2 id="message-proto">Message Proto</h2>
<h3 id="define-protos">Define Protos</h3>
<p><code>GameInfo.proto</code></p>
<pre><code class="lang-C++">package game.info;

option java_package = <span class="hljs-string">&quot;com.game.info&quot;</span>;
option java_outer_classname = <span class="hljs-string">&quot;GameInfoProtos&quot;</span>;

import <span class="hljs-string">&quot;GameEnum.proto&quot;</span>;

<span class="hljs-comment">// role info</span>
message RoleInfo {
    required <span class="hljs-built_in">string</span> name                    = <span class="hljs-number">1</span>;
    required enumeration.RoleType type      = <span class="hljs-number">2</span>;    
}

<span class="hljs-comment">// item info</span>
message ItemInfo {
    required <span class="hljs-built_in">string</span> name                    = <span class="hljs-number">1</span>;
    optional int32 price                    = <span class="hljs-number">2</span>;
}

<span class="hljs-comment">// game info</span>
message GameInfo {
    repeated RoleInfo roleInfo              = <span class="hljs-number">1</span>;
    repeated ItemInfo itemInfo              = <span class="hljs-number">2</span>;
}
</code></pre>
<p><code>GameEnum.proto</code></p>
<pre><code class="lang-C++">package game.enumeration;

option java_package = <span class="hljs-string">&quot;com.game.enumeration&quot;</span>;
option java_outer_classname = <span class="hljs-string">&quot;GameEnumProtos&quot;</span>;

<span class="hljs-comment">// enumeration type</span>
<span class="hljs-keyword">enum</span> RoleType {
    FIGHTER     = <span class="hljs-number">1</span>;
    BOWMAN      = <span class="hljs-number">2</span>;
    MAGICIAN    = <span class="hljs-number">3</span>;
}
</code></pre>
<p><br></p>
<h3 id="compiler-proto">Compiler <code>.proto</code></h3>
<pre><code class="lang-shell">protoc 
    --proto_path=IMPORT_PATH 
    --cpp_out=DST_DIR 
    --java_out=DST_DIR 
    --python_out=DST_DIR 
    path/to/file.proto
</code></pre>
<p>and will generate :</p>
<ul>
<li><p><code>c++</code></p>
<ul>
<li><code>GameEnum.pb.h</code></li>
<li><code>GameEnum.pb.cc</code></li>
<li><code>GameInfo.pb.h</code></li>
<li><code>GameInfo.pb.cc</code></li>
</ul>
</li>
<li><p>java</p>
</li>
<li>game</li>
<li>enumeration</li>
<li><code>GameEnumProtos.java</code></li>
<li>info</li>
<li><code>GameInfoProtos.java</code></li>
</ul>
<ul>
<li><code>python</code><ul>
<li><code>GameEnum_pb2.py</code></li>
<li><code>GameInfo_pb2.py</code></li>
</ul>
</li>
</ul>
<ul>
<li><p><code>javascript</code></p>
<pre><code>    Only `.proto` needed.
</code></pre></li>
</ul>
<p><br></p>
<h2 id="serialize--parse--c">Serialize &amp;&amp; Parse / <code>C++</code></h2>
<h4 id="folder-structure"><code>Folder structure</code></h4>
<pre><code class="lang-C++">- CPP
    <span class="hljs-comment">// proto generated files</span>
    - GameEnum.pb.h
    - GameEnum.pb.cc
    - GameInfo.pb.h
    - GameInfo.pb.cc
    <span class="hljs-comment">// .proto</span>
    - proto
        - GameInfo.proto
        - GameEnum.proto
    <span class="hljs-comment">// protobuf source code</span>
    - google
        - protobuf
            - <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// main test file</span>
    - CPP_TEST.cpp
</code></pre>
<p><br></p>
<h4 id="create-instance"><code>Create Instance</code></h4>
<pre><code class="lang-C++"><span class="hljs-comment">// Create a GameInfo object first</span>
game::info::GameInfo gameInfo;

<span class="hljs-comment">// add RoleInfo object to repeated field</span>
game::info::RoleInfo *pRoleInfo1 = gameInfo.add_roleinfo();
pRoleInfo1-&gt;set_name(<span class="hljs-string">&quot;name1&quot;</span>);
pRoleInfo1-&gt;set_type(game::enumeration::FIGHTER);

<span class="hljs-comment">// add another RoleInfo object to repeated field</span>
game::info::RoleInfo *pRoleInfo2 = gameInfo.add_roleinfo();
pRoleInfo2-&gt;set_name(<span class="hljs-string">&quot;name2&quot;</span>);
pRoleInfo2-&gt;set_type(game::enumeration::BOWMAN);

<span class="hljs-comment">// add ItemInfo object to repeated field</span>
game::info::ItemInfo *pItemInfo1 = gameInfo.add_iteminfo();
pItemInfo1-&gt;set_name(<span class="hljs-string">&quot;item1&quot;</span>);
pItemInfo1-&gt;set_price(<span class="hljs-number">100</span>);

<span class="hljs-comment">// add another ItemInfo object to repeated field</span>
game::info::ItemInfo *pItemInfo2 = gameInfo.add_iteminfo();
pItemInfo2-&gt;set_name(<span class="hljs-string">&quot;item2&quot;</span>);
pItemInfo2-&gt;set_price(<span class="hljs-number">200</span>);
</code></pre>
<p><br></p>
<h4 id="serialize-to-string"><code>Serialize to String</code></h4>
<pre><code class="lang-C++"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> gameInfoString;
gameInfo.SerializeToString(&amp;gameInfoString);
</code></pre>
<p><br></p>
<h4 id="serialize-to-file"><code>Serialize to File</code></h4>
<pre><code class="lang-C++"><span class="hljs-function">ofstream <span class="hljs-title">outputFile</span><span class="hljs-params">(<span class="hljs-string">&quot;GameInfo.bin&quot;</span>, <span class="hljs-built_in">std</span>::ostream::binary)</span></span>;
gameInfo.SerializeToOstream(&amp;outputFile);
</code></pre>
<p><br></p>
<h4 id="parse-from-string"><code>Parse from String</code></h4>
<pre><code class="lang-C++">game::info::GameInfo gameInfo;
gameInfo.ParseFromString(gameInfoString);
</code></pre>
<p><br></p>
<h4 id="parse-from-file"><code>Parse from File</code></h4>
<pre><code class="lang-C++">game::info::GameInfo gameInfo;
<span class="hljs-function">ifstream <span class="hljs-title">is</span><span class="hljs-params">(<span class="hljs-string">&quot;GameInfo.bin&quot;</span>, <span class="hljs-built_in">std</span>::ifstream::binary)</span></span>;
gameInfo.ParseFromIstream(&amp;is);
is.close();
</code></pre>
<p><br></p>
<h4 id="dump-gameinfo-instance"><code>Dump GameInfo Instance</code></h4>
<pre><code class="lang-C++"><span class="hljs-comment">// RoleInfo Array</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; gameInfo.roleinfo_size(); i++) {
    <span class="hljs-comment">// role info</span>
    game::info::RoleInfo roleInfo = gameInfo.roleinfo(i);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;roleInfo: \n%s\n&quot;</span>, roleInfo.Utf8DebugString().c_str());
}

<span class="hljs-comment">// ItemInfo Array</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; gameInfo.iteminfo_size(); i++) {
    <span class="hljs-comment">// role info</span>
    game::info::ItemInfo itemInfo = gameInfo.iteminfo(i);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;itemInfo: \n%s\n&quot;</span>, itemInfo.Utf8DebugString().c_str());
}
</code></pre>
<p><br></p>
<h4 id="relection-dump-message"><code>Relection Dump Message</code></h4>
<pre><code class="lang-C++"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dumpMessageReflection</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Message* pMessageInfo)</span>
</span>{
    <span class="hljs-comment">// Descriptor</span>
    <span class="hljs-keyword">const</span> Descriptor* pDescriptor = pMessageInfo-&gt;GetDescriptor();
    <span class="hljs-comment">// Reflection</span>
    <span class="hljs-keyword">const</span> Reflection* pReflection = pMessageInfo-&gt;GetReflection();
    <span class="hljs-comment">// Fields</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pDescriptor-&gt;field_count(); i ++) {
        <span class="hljs-keyword">const</span> FieldDescriptor* pMessageField = pDescriptor-&gt;field(i);
        <span class="hljs-keyword">int</span> fieldSize = pMessageField-&gt;is_repeated() ? 
            pReflection-&gt;FieldSize(*pMessageInfo, pMessageField) : <span class="hljs-number">0</span>;
        <span class="hljs-comment">// Field</span>
        <span class="hljs-keyword">switch</span>(pMessageField-&gt;type()) {
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_INT64 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_UINT64 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_FIXED64 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_FIXED32 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_BOOL :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_GROUP :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_BYTES :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_UINT32 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_SFIXED32 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_SFIXED64 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_SINT32 :
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_SINT64 :
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;FieldDescriptor type not handled !&quot;</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_INT32 :
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %d\n\n&quot;</span>, 
                        pReflection-&gt;GetInt32(*pMessageInfo, pMessageField)
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %d\n\n&quot;</span>, 
                            pReflection-&gt;GetRepeatedInt32(
                                *pMessageInfo, pMessageField, j
                            )
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_FLOAT :
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %f\n\n&quot;</span>, 
                        pReflection-&gt;GetFloat(*pMessageInfo, pMessageField)
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %f\n\n&quot;</span>, 
                            pReflection-&gt;GetRepeatedFloat(
                                *pMessageInfo, pMessageField, j
                            )
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_DOUBLE :
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %lf\n\n&quot;</span>, 
                        pReflection-&gt;GetDouble(*pMessageInfo, pMessageField)
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %lf\n\n&quot;</span>, 
                            pReflection-&gt;GetRepeatedDouble(
                                *pMessageInfo, pMessageField, j
                            )
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_STRING :
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %s\n\n&quot;</span>, 
                        pReflection-&gt;GetString(
                            *pMessageInfo, pMessageField
                        ).c_str()
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %s\n\n&quot;</span>, 
                            pReflection-&gt;GetRepeatedString(
                                *pMessageInfo, pMessageField, j
                            ).c_str()
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_ENUM :
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %d\n\n&quot;</span>, 
                        pReflection-&gt;GetEnum(
                            *pMessageInfo, pMessageField
                        )-&gt;number()
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Value: %d\n\n&quot;</span>, 
                            pReflection-&gt;GetRepeatedEnum(
                                *pMessageInfo, pMessageField, j
                            )-&gt;number()
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FieldDescriptor::TYPE_MESSAGE :
                <span class="hljs-comment">// recurse</span>
                <span class="hljs-keyword">if</span> (fieldSize == <span class="hljs-number">0</span>) {
                    dumpMessageReflection(
                        &amp;pReflection-&gt;GetMessage(*pMessageInfo, pMessageField)
                    );
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; fieldSize; j ++) {
                        dumpMessageReflection(
                            &amp;pReflection-&gt;GetRepeatedMessage(
                                *pMessageInfo, pMessageField, j
                            )
                        );
                    }
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<p><br></p>
<h4 id="relection-generate-message"><code>Relection Generate Message</code></h4>
<pre><code class="lang-C++">compiler::DiskSourceTree sourceTree;
sourceTree.MapPath(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;./proto&quot;</span>);
compiler::<span class="hljs-function">Importer <span class="hljs-title">importer</span><span class="hljs-params">(&amp;sourceTree, <span class="hljs-literal">NULL</span>)</span></span>;
importer.Import(<span class="hljs-string">&quot;GameEnum.proto&quot;</span>);
importer.Import(<span class="hljs-string">&quot;GameInfo.proto&quot;</span>);

DynamicMessageFactory factory;
<span class="hljs-keyword">const</span> Descriptor* pDescriptorDynamic = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">const</span> Reflection* pReflectionDynamic = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">const</span> FieldDescriptor* pFieldDynamic = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">const</span> EnumDescriptor* pEnumDescriptorDynamic = <span class="hljs-literal">NULL</span>;
Message* pGameInfoDynamic = <span class="hljs-literal">NULL</span>;
Message* pRoleInfoDynamic = <span class="hljs-literal">NULL</span>;
Message* pItemInfoDynamic = <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">// create a instance of GameInfo</span>
pDescriptorDynamic = importer.pool()-&gt;FindMessageTypeByName(<span class="hljs-string">&quot;game.info.GameInfo&quot;</span>);
pGameInfoDynamic = factory.GetPrototype(pDescriptorDynamic)-&gt;New();
pReflectionDynamic = pGameInfoDynamic-&gt;GetReflection();

<span class="hljs-comment">// get repeated roleinfo instance</span>
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;roleInfo&quot;</span>);
pRoleInfoDynamic = pReflectionDynamic-&gt;AddMessage(pGameInfoDynamic, pFieldDynamic);

<span class="hljs-comment">// set string filed name</span>
pDescriptorDynamic = importer.pool()-&gt;FindMessageTypeByName(<span class="hljs-string">&quot;game.info.RoleInfo&quot;</span>);
pEnumDescriptorDynamic = 
    importer.pool()-&gt;FindEnumTypeByName(<span class="hljs-string">&quot;game.enumeration.RoleType&quot;</span>);
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;name&quot;</span>);
pRoleInfoDynamic-&gt;GetReflection()-&gt;SetString(
    pRoleInfoDynamic, pFieldDynamic, <span class="hljs-string">&quot;role_name_dynamic1&quot;</span>
);
<span class="hljs-comment">// set enum filed type</span>
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;type&quot;</span>);
pRoleInfoDynamic-&gt;GetReflection()-&gt;SetEnum(
    pRoleInfoDynamic, 
    pFieldDynamic, 
    pEnumDescriptorDynamic-&gt;FindValueByName(<span class="hljs-string">&quot;MAGICIAN&quot;</span>)
);

<span class="hljs-comment">// get repeated iteminfo instance</span>
pDescriptorDynamic = importer.pool()-&gt;FindMessageTypeByName(<span class="hljs-string">&quot;game.info.GameInfo&quot;</span>);
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;itemInfo&quot;</span>);
pItemInfoDynamic = pReflectionDynamic-&gt;AddMessage(pGameInfoDynamic, pFieldDynamic);

<span class="hljs-comment">// set string filed name</span>
pDescriptorDynamic = importer.pool()-&gt;FindMessageTypeByName(<span class="hljs-string">&quot;game.info.ItemInfo&quot;</span>);
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;name&quot;</span>);
pItemInfoDynamic-&gt;GetReflection()-&gt;SetString(
    pItemInfoDynamic, pFieldDynamic, <span class="hljs-string">&quot;item_name_dynamic1&quot;</span>
);
<span class="hljs-comment">// set int32 filed type</span>
pFieldDynamic = pDescriptorDynamic-&gt;FindFieldByName(<span class="hljs-string">&quot;price&quot;</span>);
pItemInfoDynamic-&gt;GetReflection()-&gt;SetInt32(
    pItemInfoDynamic, pFieldDynamic, <span class="hljs-number">999999</span>
);
</code></pre>
<p><br></p>
<h4 id="compiler--run"><code>Compiler &amp;&amp; Run</code></h4>
<pre><code class="lang-shell">Comliper :
g++ -c -I./ GameInfo.pb.cc
g++ -c -I./ GameEnum.pb.cc
g++ -c -I./ CPP_TEST.cpp

Link :
g++ -L./ -lprotobuf GameEnum.pb.o GameInfo.pb.o CPP_TEST.o -o main

Compiler &amp;&amp; Run :
g++ -I./ -L./ -lprotobuf GameInfo.pb.cc GameEnum.pb.cc CPP_TEST.cpp -o main

Run :
./main
</code></pre>
<p><br></p>
<h3 id="serialize--parse--javascript">Serialize &amp;&amp; Parse / <code>javascript</code></h3>
<blockquote>
<p>  <a href="https://github.com/dcodeIO/protobuf.js" target="_blank">https://github.com/dcodeIO/protobuf.js</a></p>
</blockquote>
<h4 id="load-proto">Load Proto</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// cocos2d-js style</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;bytebuffer.js&quot;</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;protobuf.js&quot;</span>);
<span class="hljs-keyword">var</span> ProtoBuf = dcodeIO.ProtoBuf;

<span class="hljs-comment">// node.js style</span>
<span class="hljs-comment">// var ProtoBuf = require(&quot;./dist/protobuf&quot;);</span>

<span class="hljs-keyword">var</span> GameInfoBuilder = ProtoBuf.newBuilder();

<span class="hljs-comment">// load .proto</span>
ProtoBuf.loadProtoFile(<span class="hljs-string">&quot;../PROTO/GameInfo.proto&quot;</span>, <span class="hljs-literal">null</span>, xappBuilder);
ProtoBuf.loadProtoFile(<span class="hljs-string">&quot;../PROTO/GameEnum.proto&quot;</span>, <span class="hljs-literal">null</span>, xappBuilder);
</code></pre>
<p><br></p>
<h4 id="create-instance">Create Instance</h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> Game = GameInfoBuilder.build(<span class="hljs-string">&quot;game&quot;</span>);

<span class="hljs-comment">// game</span>
<span class="hljs-keyword">var</span> gameInfoOut = <span class="hljs-keyword">new</span> Game.info.GameInfo();

<span class="hljs-comment">// role</span>
<span class="hljs-keyword">var</span> roleInfo1 = <span class="hljs-keyword">new</span> Game.info.RoleInfo();
roleInfo1.name = <span class="hljs-string">&quot;name1&quot;</span>;
roleInfo1.type = Game.enumeration.RoleType.FIGHTER;
gameInfoOut.roleInfo.push(roleInfo1);

<span class="hljs-keyword">var</span> roleInfo2 = <span class="hljs-keyword">new</span> Game.info.RoleInfo();
roleInfo2.name = <span class="hljs-string">&quot;name2&quot;</span>;
roleInfo2.type = Game.enumeration.RoleType.BOWMAN;
gameInfoOut.roleInfo.push(roleInfo2);

<span class="hljs-comment">// item</span>
<span class="hljs-keyword">var</span> itemInfo1 = <span class="hljs-keyword">new</span> Game.info.ItemInfo();
itemInfo1.name = <span class="hljs-string">&quot;item1&quot;</span>;
itemInfo1.price = <span class="hljs-number">100</span>;
gameInfoOut.itemInfo.push(itemInfo1);

<span class="hljs-keyword">var</span> itemInfo2 = <span class="hljs-keyword">new</span> Game.info.ItemInfo();
itemInfo2.name = <span class="hljs-string">&quot;item2&quot;</span>;
itemInfo2.price = <span class="hljs-number">200</span>;
gameInfoOut.itemInfo.push(itemInfo2);
</code></pre>
<p><br></p>
<h4 id="encode--decode">Encode / Decode</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// encode</span>
<span class="hljs-keyword">var</span> gameInfoData = gameInfoOut.encodeAB();

<span class="hljs-comment">// decode</span>
<span class="hljs-keyword">var</span> gameInfoIn = Game.info.GameInfo.decode(gameInfoData, <span class="hljs-string">&quot;utf8&quot;</span>);

<span class="hljs-comment">// dump</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; gameInfoIn.roleInfo.length; i ++) {
    <span class="hljs-keyword">var</span> roleInfo = gameInfoIn.roleInfo[i];
    <span class="hljs-built_in">console</span>.log(<span class="hljs-comment">/* ... */</span>);
}

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; gameInfoIn.itemInfo.length; i ++) {
    <span class="hljs-keyword">var</span> itemInfo = gameInfoIn.itemInfo[i];
    <span class="hljs-built_in">console</span>.log(<span class="hljs-comment">/* ... */</span>);
}
</code></pre>
<p><br></p>
<h4 id="load-from-bin">Load from <code>.bin</code></h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> gameInfo = <span class="hljs-keyword">new</span> Game.info.GameInfo();
<span class="hljs-keyword">var</span> content = ProtoBuf.Util.fetch(<span class="hljs-string">&quot;../BIN/RoleInfo.bin&quot;</span>);
<span class="hljs-keyword">var</span> gameInfo = Game.info.GameInfo.decode(content, <span class="hljs-string">&quot;utf8&quot;</span>);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; gameInfo.roleInfo.length; i ++) {
    <span class="hljs-keyword">var</span> roleInfo = gameInfo.roleInfo[i];
    <span class="hljs-built_in">console</span>.log(<span class="hljs-comment">/* ... */</span>);
}

content = ProtoBuf.Util.fetch(<span class="hljs-string">&quot;../BIN/ItemInfo.bin&quot;</span>);
gameInfo = Game.info.GameInfo.decode(content, <span class="hljs-string">&quot;utf8&quot;</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; gameInfo.itemInfo.length; i ++) {
    <span class="hljs-keyword">var</span> itemInfo = gameInfo.itemInfo[i];
    <span class="hljs-built_in">console</span>.log(<span class="hljs-comment">/* ... */</span>);
}
</code></pre>
<p><br></p>
<h3 id="excel-xls-to-protobuf-bin--python">Excel <code>.xls</code> to ProtoBuf <code>.bin</code> / <code>Python</code></h3>
<h4 id="excel-format">Excel Format</h4>
<p>excel : <code>ItemInfo.xls</code> </p>
<p>sheet name: <code>ItemInfo</code></p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>price</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>item_name_1</td>
<td>111</td>
</tr>
<tr>
<td>2</td>
<td>item_name_2</td>
<td>222</td>
</tr>
<tr>
<td>3</td>
<td>item_name_3</td>
<td>333</td>
</tr>
</tbody>
</table>
<p>excel : <code>RoleInfo.xls</code> </p>
<p>sheet name: <code>RoleInfo</code></p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>role_name_1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>role_name_2</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>role_name_3</td>
<td>3</td>
</tr>
</tbody>
</table>
<p><br></p>
<h4 id="compiler-proto">Compiler <code>.proto</code></h4>
<pre><code class="lang-python"><span class="hljs-comment"># dir</span>
PB_DIR = <span class="hljs-string">&apos;./PROTO&apos;</span>
PB_PY_DIR = <span class="hljs-string">&apos;./PYTHON&apos;</span>
XLS_DIR = <span class="hljs-string">&apos;./XLS&apos;</span>
BIN_DIR = <span class="hljs-string">&apos;./BIN&apos;</span>

<span class="hljs-string">&apos;&apos;&apos;
    eg:
        compile_protobuf(PB_DIR, PB_PY_DIR, &apos;a.proto&apos;, &apos;python&apos;)
        compile_protobuf(PB_DIR, PB_CPP_DIR, &apos;a.proto&apos;, &apos;cpp&apos;)
        compile_protobuf(PB_DIR, PB_JAVA_DIR, &apos;a.proto&apos;, &apos;java&apos;)
&apos;&apos;&apos;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compile_protobuf</span><span class="hljs-params">(src, dst, proto_file, language)</span>:</span>
    <span class="hljs-keyword">if</span> language == <span class="hljs-string">&apos;cpp&apos;</span>:
        out_language = <span class="hljs-string">&apos;cpp_out&apos;</span>
    <span class="hljs-keyword">elif</span> language == <span class="hljs-string">&apos;python&apos;</span>:
        out_language = <span class="hljs-string">&apos;python_out&apos;</span>
    <span class="hljs-keyword">elif</span> language == <span class="hljs-string">&apos;java&apos;</span>:
        out_language = <span class="hljs-string">&apos;java_out&apos;</span>
    <span class="hljs-keyword">else</span>:
        out_language = <span class="hljs-string">&apos;python_out&apos;</span>
    os.system(<span class="hljs-string">&apos;protoc -I=%s --%s=%s %s&apos;</span> % (
        src, out_language, dst, src + <span class="hljs-string">&apos;/&apos;</span> + proto_file)
    )
</code></pre>
<p>The output :</p>
<pre><code class="lang-C++">- PYTHON
    GameInfo_pb2.py
    GameEnum_pb2.py
</code></pre>
<p><br></p>
<h4 id="dynamic-import">Dynamic import</h4>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> inspect

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dynamic_import</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">import</span> PYTHON.GameInfo_pb2
    import_py = __import__(<span class="hljs-string">&apos;PYTHON.GameInfo_pb2&apos;</span>)
    pb_attr = getattr(import_py, <span class="hljs-string">&apos;GameInfo_pb2&apos;</span>)
    <span class="hljs-keyword">del</span> import_py

    <span class="hljs-keyword">for</span> name, obj <span class="hljs-keyword">in</span> inspect.getmembers(PYTHON.GameInfo_pb2):
        <span class="hljs-keyword">if</span> inspect.isclass(obj):
            import_pb_class(pb_attr, name)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_pb_class</span><span class="hljs-params">(pb_attr, class_name)</span>:</span>
    attr = getattr(pb_attr, class_name)
    setattr(sys.modules[__name__], class_name, attr)

    descriptor = make_descriptor_name(class_name)
    attr = getattr(pb_attr, descriptor)
    setattr(sys.modules[__name__], descriptor, attr)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_descriptor_name</span><span class="hljs-params">(class_name)</span>:</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;_&apos;</span> + class_name.upper()
</code></pre>
<p><br></p>
<h4 id="parse-xls">Parse <code>.xls</code></h4>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_xls_files</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">for</span> worksheet_name, table <span class="hljs-keyword">in</span> get_xls_files().items():
        message_object = class_from_string(worksheet_name)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message_object:
            <span class="hljs-keyword">continue</span>
        fields = list_fields(make_descriptor_name(worksheet_name))
        parse_table(worksheet_name, table, fields)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">class_from_string</span><span class="hljs-params">(class_name)</span>:</span>
    <span class="hljs-keyword">try</span>:
        instance = getattr(sys.modules[__name__], class_name)()
        <span class="hljs-keyword">return</span> instance
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>
</code></pre>
<p><br></p>
<h4 id="list-fields">List fields</h4>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_fields</span><span class="hljs-params">(class_name)</span>:</span>
    fields = []
    <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> getattr(sys.modules[__name__], class_name).fields:
        fields.append([field.name, field.type, field.index])
    <span class="hljs-keyword">return</span> fields
</code></pre>
<p><br></p>
<h4 id="parse-table">Parse table</h4>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_table</span><span class="hljs-params">(worksheet_name, table, fields)</span>:</span>
    <span class="hljs-comment">## all data will be put into a GameInfo instance</span>
    gameInfo = class_from_string(<span class="hljs-string">&apos;GameInfo&apos;</span>)
    <span class="hljs-keyword">for</span> ri <span class="hljs-keyword">in</span> range(len(table)):
        <span class="hljs-comment"># ...</span>
        row = table[ri]
        message = <span class="hljs-keyword">None</span>
        <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> fields:
            value_index = get_value_index(table[<span class="hljs-number">0</span>], field[<span class="hljs-number">0</span>])
            <span class="hljs-comment"># ...</span>
            value = convert_pb_type(row[value_index][<span class="hljs-number">1</span>], field[<span class="hljs-number">1</span>])
            <span class="hljs-comment"># ...</span>
            message = getattr(
                gameInfo, worksheet_name[<span class="hljs-number">0</span>].lower() + worksheet_name[<span class="hljs-number">1</span>:]
            ).add() 
            setattr(message, field[<span class="hljs-number">0</span>], value)
    <span class="hljs-comment"># write to .bin</span>
    <span class="hljs-comment"># ...</span>
    serializedObject = gameInfo.SerializeToString()
    pb_bin_file = <span class="hljs-string">&quot;./bin/%s.bin&quot;</span> % worksheet_name
    pb_bin = open(pb_bin_file, <span class="hljs-string">&quot;wb&quot;</span>)
    pb_bin.write(serializedObject)
    pb_bin.close()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_pb_type</span><span class="hljs-params">(value, type)</span>:</span>
    <span class="hljs-keyword">if</span> type <span class="hljs-keyword">in</span> [FieldDescriptor.TYPE_INT64, 
                FieldDescriptor.TYPE_UINT64, 
                FieldDescriptor.TYPE_INT32, 
                FieldDescriptor.TYPE_ENUM]:
        <span class="hljs-keyword">return</span> int(value)
    <span class="hljs-keyword">elif</span> type <span class="hljs-keyword">in</span> [FieldDescriptor.TYPE_DOUBLE, 
                  FieldDescriptor.TYPE_FLOAT]:
        <span class="hljs-keyword">return</span> float(value)
    <span class="hljs-keyword">elif</span> type <span class="hljs-keyword">in</span> [FieldDescriptor.TYPE_STRING]:
        <span class="hljs-keyword">if</span> isinstance(value, basestring):
            <span class="hljs-keyword">return</span> value
        <span class="hljs-keyword">elif</span> isinstance(value, float):
            <span class="hljs-keyword">return</span> str(int(value))
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> str(value)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">None</span>
</code></pre>
<p>Generated <code>.bin</code></p>
<pre><code class="lang-C++"><span class="hljs-comment">// ItemInfo.bin</span>
GameInfo
    repeated RoleInfo roleInfo =&gt;
    {
        RoleInfo1,
        RoleInfo2,
        RoleInfo3,
        ...
    }
    repeated ItemInfo itemInfo =&gt; None

<span class="hljs-comment">// RoleInfo.bin</span>
GameInfo
    repeated RoleInfo roleInfo =&gt; None
    repeated ItemInfo itemInfo =&gt; 
    {
        ItemInfo1,
        ItemInfo2,
        ItemInfo3,
        ...
    }
</code></pre>
<p><br></p>
<h4 id="bin-security"><code>.bin</code> security</h4>
<p><code>.bin</code> can be decoded using <code>protoc</code> command.</p>
<h5 id="decode-with-proto">decode with <code>proto</code></h5>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> subprocess

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span><span class="hljs-params">(message_name, proto_name, bin_name)</span>:</span>
    process = subprocess.Popen(
        [<span class="hljs-string">&apos;/usr/local/bin/protoc&apos;</span>, <span class="hljs-string">&apos;--decode&apos;</span>, message_name, proto_name],
        stdin = subprocess.PIPE,
        stdout = subprocess.PIPE,
        stderr = subprocess.PIPE
    )

    output = error = <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">try</span>:
        f = open(bin_name, <span class="hljs-string">&quot;rb&quot;</span>)
        data = f.read()
        f.close()
        output, error = process.communicate(data)
        <span class="hljs-keyword">if</span> error:
            <span class="hljs-keyword">print</span> <span class="hljs-string">&apos;error: &apos;</span> + error 
    <span class="hljs-keyword">except</span> OSError:
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">if</span> process.poll() != <span class="hljs-number">0</span>:
            process.wait()
    <span class="hljs-keyword">return</span> output

<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ result ------\n&apos;</span>
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;message_name: &apos;</span> + sys.argv[<span class="hljs-number">1</span>]
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;proto_name: &apos;</span> + sys.argv[<span class="hljs-number">2</span>]
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;bin_name: &apos;</span> + sys.argv[<span class="hljs-number">3</span>]
<span class="hljs-keyword">print</span>
<span class="hljs-keyword">print</span> decode(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>], sys.argv[<span class="hljs-number">3</span>])
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ ------ ------\n&apos;</span>
</code></pre>
<p>Test with <code>ItemInfo.bin</code></p>
<pre><code class="lang-shell">root$ python decode.py game.info.GameInfo GameInfo.proto ItemInfo.bin

------ result ------
message_name: game.info.GameInfo
proto_name: GameInfo.proto
bin_name: ItemInfo.bin

itemInfo {
  name: &quot;item1&quot;
  price: 100
}
itemInfo {
  name: &quot;item2&quot;
  price: 101
}
......
------ ------ ------
</code></pre>
<h5 id="decode-with-proto">decode with <code>proto</code></h5>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> subprocess

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode_raw</span><span class="hljs-params">(data)</span>:</span>
    process = subprocess.Popen(
        [<span class="hljs-string">&apos;/usr/local/bin/protoc&apos;</span>, <span class="hljs-string">&apos;--decode_raw&apos;</span>],
        stdin = subprocess.PIPE,
        stdout = subprocess.PIPE,
        stderr = subprocess.PIPE
    )
    output = error = <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">try</span>:
        output, error = process.communicate(data)
    <span class="hljs-keyword">except</span> OSError:
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">if</span> process.poll() != <span class="hljs-number">0</span>:
            process.wait()
    <span class="hljs-keyword">return</span> output

f = open(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;rb&quot;</span>)
data = f.read()
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ data ------\n&apos;</span>
<span class="hljs-keyword">print</span> data
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ ------ ------\n&apos;</span>

<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ result ------\n&apos;</span>
<span class="hljs-keyword">print</span> decode_raw(data)
<span class="hljs-keyword">print</span> <span class="hljs-string">&apos;------ ------ ------\n&apos;</span>
f.close()
</code></pre>
<p>Test with <code>ItemInfo.bin</code></p>
<pre><code class="lang-shell">root$ python decode_raw.py ItemInfo.bin 

------ data ------


item1d  
item2e  
item3f  
item4g  
item5h  
item6i  
item7j  
item8k  
item9l

item10m
------ ------ ------

------ result ------

2 {
  1: &quot;item1&quot;
  2: 100
}
2 {
  1: &quot;item2&quot;
  2: 101
}
2 {
  1: &quot;item3&quot;
  2: 102
}
......
------ ------ ------
</code></pre>
<h5 id="decode-raw-data--network-data-transfer-">decode raw data ( network data transfer )</h5>
<blockquote>
<p>  <a href="https://github.com/erikdw/protoc-decode-lenprefix" target="_blank">protoc-decode-lenprefix on Github</a></p>
</blockquote>
<p><br></p>
<h3 id="jsbinding">JSBinding</h3>
<h4 id="send-from-c">Send from <code>C++</code></h4>
<pre><code class="lang-C++">JSObject* pGlobalObject = ScriptingCore::getInstance()-&gt;getGlobalObject();
JSContext* pGlobalContext = ScriptingCore::getInstance()-&gt;getGlobalContext();

<span class="hljs-comment">// Create a GameInfo object first</span>
game::info::GameInfo gameInfo;

<span class="hljs-comment">// add RoleInfo object to repeated field</span>
game::info::RoleInfo *pRoleInfo1 = gameInfo.add_roleinfo();
pRoleInfo1-&gt;set_name(<span class="hljs-string">&quot;cpp_name1&quot;</span>);
pRoleInfo1-&gt;set_type(game::enumeration::FIGHTER);

<span class="hljs-comment">// add another RoleInfo object to repeated field</span>
game::info::RoleInfo *pRoleInfo2 = gameInfo.add_roleinfo();
pRoleInfo2-&gt;set_name(<span class="hljs-string">&quot;cpp_name2&quot;</span>);
pRoleInfo2-&gt;set_type(game::enumeration::BOWMAN);

<span class="hljs-comment">// add ItemInfo object to repeated field</span>
game::info::ItemInfo *pItemInfo1 = gameInfo.add_iteminfo();
pItemInfo1-&gt;set_name(<span class="hljs-string">&quot;cpp_item1&quot;</span>);
pItemInfo1-&gt;set_price(<span class="hljs-number">100</span>);

<span class="hljs-comment">// add another ItemInfo object to repeated field</span>
game::info::ItemInfo *pItemInfo2 = gameInfo.add_iteminfo();
pItemInfo2-&gt;set_name(<span class="hljs-string">&quot;cpp_item2&quot;</span>);
pItemInfo2-&gt;set_price(<span class="hljs-number">200</span>);

<span class="hljs-comment">// SerializeToString</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> gameInfoString;
gameInfo.SerializeToString(&amp;gameInfoString);

<span class="hljs-comment">// convert gameInfoString to jsval to send to javascript</span>
<span class="hljs-function">JSAutoCompartment <span class="hljs-title">ac</span><span class="hljs-params">(pGlobalContext, pGlobalObject)</span></span>;
<span class="hljs-keyword">int</span> length = gameInfoString.length();
JSObject* pMessageJSObject = JS_NewArrayBuffer(pGlobalContext, length);
<span class="hljs-keyword">uint8_t</span>* pMessageData = JS_GetArrayBufferData(pMessageJSObject);
<span class="hljs-built_in">memcpy</span>(
    (<span class="hljs-keyword">void</span>*)pMessageData, 
    (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>*)gameInfoString.c_str(), 
    gameInfoString.length()
);

JS::<span class="hljs-function">RootedValue <span class="hljs-title">ret</span><span class="hljs-params">(pGlobalContext)</span></span>;
jsval arg = OBJECT_TO_JSVAL(pMessageJSObject);
ScriptingCore::getInstance()-&gt;executeFunctionWithOwner(
    OBJECT_TO_JSVAL(pGlobalObject), <span class="hljs-string">&quot;test_protobuf&quot;</span>, <span class="hljs-number">1</span>, &amp;arg, &amp;ret
);
</code></pre>
<p><br></p>
<h4 id="receive-from-c">Receive from <code>C++</code></h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// cc_js_bridge.js</span>
test_protobuf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">var</span> ProtoBuf = dcodeIO.ProtoBuf;
    <span class="hljs-keyword">var</span> GameInfoBuilder = ProtoBuf.newBuilder();

    <span class="hljs-comment">// load .proto</span>
    ProtoBuf.protoFromContents(
        <span class="hljs-string">&quot;res/GameEnum.proto&quot;</span>, 
        GameInfoBuilder, 
        jsb.fileUtils.getStringFromFile(<span class="hljs-string">&quot;res/GameEnum.proto&quot;</span>)
    );
    ProtoBuf.protoFromContents(
        <span class="hljs-string">&quot;res/GameInfo.proto&quot;</span>, 
        GameInfoBuilder, 
        jsb.fileUtils.getStringFromFile(<span class="hljs-string">&quot;res/GameInfo.proto&quot;</span>)
    );

    <span class="hljs-comment">// decode protobuf message from C++ </span>
    <span class="hljs-keyword">var</span> Game = GameInfoBuilder.build(<span class="hljs-string">&quot;game&quot;</span>);
    <span class="hljs-keyword">var</span> gameInfo = Game.info.GameInfo.decode(data, <span class="hljs-string">&quot;utf8&quot;</span>);
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>Add a <code>protoFromContents</code> <code>function</code> to <code>protobuf.js</code> :</p>
<pre><code class="lang-javascript">ProtoBuf.protoFromContents = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filename, builder, contents</span>) </span>{
    <span class="hljs-keyword">return</span> contents === <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : ProtoBuf.loadProto(
        contents, builder, filename
    );
};
</code></pre>
<p><br></p>
<h4 id="send-from-javascript">Send from <code>javascript</code></h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> gameInfoOut = <span class="hljs-keyword">new</span> Game.info.GameInfo();

<span class="hljs-keyword">var</span> roleInfo1 = <span class="hljs-keyword">new</span> Game.info.RoleInfo();
roleInfo1.name = <span class="hljs-string">&quot;js_name1&quot;</span>;
roleInfo1.type = Game.enumeration.RoleType.FIGHTER;
gameInfoOut.roleInfo.push(roleInfo1);

<span class="hljs-keyword">var</span> roleInfo2 = <span class="hljs-keyword">new</span> Game.info.RoleInfo();
roleInfo2.name = <span class="hljs-string">&quot;js_name2&quot;</span>;
roleInfo2.type = Game.enumeration.RoleType.BOWMAN;
gameInfoOut.roleInfo.push(roleInfo2);

<span class="hljs-keyword">var</span> itemInfo1 = <span class="hljs-keyword">new</span> Game.info.ItemInfo();
itemInfo1.name = <span class="hljs-string">&quot;js_item1&quot;</span>;
itemInfo1.price = <span class="hljs-number">100</span>;
gameInfoOut.itemInfo.push(itemInfo1);

<span class="hljs-keyword">var</span> itemInfo2 = <span class="hljs-keyword">new</span> Game.info.ItemInfo();
itemInfo2.name = <span class="hljs-string">&quot;js_item2&quot;</span>;
itemInfo2.price = <span class="hljs-number">200</span>;
gameInfoOut.itemInfo.push(itemInfo2);

<span class="hljs-keyword">return</span> gameInfoOut.encodeAB();
</code></pre>
<p><br></p>
<h4 id="receive-from-javascript">Receive from <code>javascript</code></h4>
<pre><code class="lang-C++">// ...
JS::RootedValue ret(pGlobalContext);
jsval arg = OBJECT_TO_JSVAL(pMessageJSObject);
ScriptingCore::getInstance()-&gt;executeFunctionWithOwner(
    OBJECT_TO_JSVAL(pGlobalObject), &quot;test_protobuf&quot;, 1, &amp;arg, &amp;ret
);
// convert JS::RootedValue ret to protobuf message
game::info::GameInfo* pGameInfo = new game::info::GameInfo;
JSObject* pRetJSObject = ret.toObjectOrNull();
if(pRetJSObject &amp;&amp; JS_IsArrayBufferObject(pRetJSObject)) {
    uint8_t* pDataBuffer = nullptr;
    int dataBufferCount = 0;
    pDataBuffer = JS_GetArrayBufferData(pRetJSObject);
    dataBufferCount = JS_GetArrayBufferByteLength(pRetJSObject);
    pGameInfo-&gt;ParseFromArray(pDataBuffer, dataBufferCount);
    // ...
}
</code></pre>
<p><br></p>
<h2 id="others">Others</h2>
<h3 id="sublime-text3-proto-plugin">Sublime Text3 <code>.proto</code> plugin</h3>
<p><a href="https://packagecontrol.io/packages/Protocol%20Buffer%20Syntax" target="_blank">Protocol Buffer Syntax</a></p>
<blockquote>
<p>  <a href="https://github.com/google/protobuf" target="_blank">https://github.com/google/protobuf</a></p>
<p>  <a href="https://github.com/google/protobuf/releases" target="_blank">https://github.com/google/protobuf/releases</a></p>
</blockquote>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./index.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Introduction"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-disqus/plugin.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"sharing":{"weibo":true,"facebook":true,"twitter":true,"google":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"disqus":{"shortName":"supersuraccoon-gitbook","useIdentifier":false},"advanced-emoji":{"embedEmojis":false},"highlight":{},"search":{"maxIndexSize":1000000},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
